<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="keywords" content=""><meta name="theme-color" content="#3F51B5"><meta name="summary" content="BuptStEve"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>「12」小程序之告别“刀耕火种” | BuptStEve&#39;s Blog | Talk is cheap show me the offer!</title><meta name="description" content="开门见山地说，小程序在日常开发中使用原生框架来开发还是挺不方便的，比如：  不支持 npm 包 不支持各种 CSS 预编译器 不支持配置 Babel 来转换一些 JavaScript 新特性  这样一来和日常开发前端页面的体验相比来说，简直就像在刀耕火种。  那么为了解决这些问题，我们能不能将前端开发中常用的 webpack 移植到小程序开发中呢？  当然可以！  0.源码地址    在 webp"><meta name="keywords" content="tua-mp,小程序"><meta property="og:type" content="article"><meta property="og:title" content="「12」小程序之告别“刀耕火种”"><meta property="og:url" content="https://buptsteve.github.io/blog/2018/06/03/12.say-goodbye-to-mina-native/index.html"><meta property="og:site_name" content="BuptStEve&#39;s Blog"><meta property="og:description" content="开门见山地说，小程序在日常开发中使用原生框架来开发还是挺不方便的，比如：  不支持 npm 包 不支持各种 CSS 预编译器 不支持配置 Babel 来转换一些 JavaScript 新特性  这样一来和日常开发前端页面的体验相比来说，简直就像在刀耕火种。  那么为了解决这些问题，我们能不能将前端开发中常用的 webpack 移植到小程序开发中呢？  当然可以！  0.源码地址    在 webp"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://webpack.js.org/assets/icon-square-big.svg"><meta property="og:updated_time" content="2018-06-03T12:02:50.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="「12」小程序之告别“刀耕火种”"><meta name="twitter:description" content="开门见山地说，小程序在日常开发中使用原生框架来开发还是挺不方便的，比如：  不支持 npm 包 不支持各种 CSS 预编译器 不支持配置 Babel 来转换一些 JavaScript 新特性  这样一来和日常开发前端页面的体验相比来说，简直就像在刀耕火种。  那么为了解决这些问题，我们能不能将前端开发中常用的 webpack 移植到小程序开发中呢？  当然可以！  0.源码地址    在 webp"><meta name="twitter:image" content="https://webpack.js.org/assets/icon-square-big.svg"><link rel="shortcut icon" href="/blog/img/favicon.ico"><link rel="stylesheet" href="/blog/css/style.css"><link rel="alternative" href="/blog/atom.xml" title="BuptStEve&#39;s Blog" type="application/atom+xml"></head><body><div id="loading" class="active"></div><nav id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap"><div class="brand"><a href="/blog" class="avatar"><img src="/blog/img/logo.jpg"></a><hgroup class="introduce"><h5 class="nickname">Steve Young</h5><a href="mailto:yangzhenyu2016@gmail.com" title="yangzhenyu2016@gmail.com" class="mail">yangzhenyu2016@gmail.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/blog/"><i class="icon icon-lg icon-home"></i> 主页</a></li><li class="waves-block waves-effect"><a href="/blog/archives"><i class="icon icon-lg icon-archives"></i> Archives</a></li><li class="waves-block waves-effect"><a href="/blog/tags"><i class="icon icon-lg icon-tags"></i> Tags</a></li><li class="waves-block waves-effect"><a href="https://github.com/buptsteve" target="_blank"><i class="icon icon-lg icon-github"></i> Github</a></li><li class="waves-block waves-effect"><a href="http://weibo.com/0osteveyoungo0" target="_blank"><i class="icon icon-lg icon-weibo"></i> Weibo</a></li></ul><footer class="footer"><p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC"></a></p><p>BuptStEve&#39;s Blog &copy; 2018</p><p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p><a href="/blog/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a></footer></div></div></nav><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">「12」小程序之告别“刀耕火种”</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i></a> <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div></div></header><header class="content-header"><div class="container"><h1 class="author">「12」小程序之告别“刀耕火种”</h1><h5 class="subtitle"><time datetime="2018-06-03T09:45:00.000Z" itemprop="datePublished" class="page-time">2018-06-03</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/blog/categories/前端/">前端</a></li></ul></h5></div></header><div class="container body-wrap"><article id="post-12.say-goodbye-to-mina-native" class="article article-type-post" itemprop="blogPost"><div class="post-meta flex-row"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tua-mp/">tua-mp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/小程序/">小程序</a></li></ul></div><div class="post-body"><aside class="post-widget" id="post-widget"><nav class="post-toc-wrap" id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0-源码地址"><span class="post-toc-text">0.源码地址</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-文件结构"><span class="post-toc-text">1.文件结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1-src-中文件结构大概长这样："><span class="post-toc-text">1.1.src/ 中文件结构大概长这样：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-dist-中文件结构大概长这样："><span class="post-toc-text">1.2.dist/ 中文件结构大概长这样：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-3-整个项目文件结构大概长这样："><span class="post-toc-text">1.3.整个项目文件结构大概长这样：</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-webpack-基础配置"><span class="post-toc-text">2.webpack 基础配置</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-1-entry-output"><span class="post-toc-text">2.1.entry/output</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-2-CommonChunk"><span class="post-toc-text">2.2.CommonChunk</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-3-CopyWebpackPlugin"><span class="post-toc-text">2.3.CopyWebpackPlugin</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-4-预处理器和-CSS-的处理"><span class="post-toc-text">2.4.预处理器和 CSS 的处理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-webpack-vue-loader"><span class="post-toc-text">3.webpack + vue-loader</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-vue-loader-v15"><span class="post-toc-text">3.1.vue-loader v15?</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-options-compiler"><span class="post-toc-text">3.2.options.compiler</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-3-Custom-Blocks"><span class="post-toc-text">3.3.Custom Blocks</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-总结"><span class="post-toc-text">4.总结</span></a></li></ol></nav></aside><div class="post-main"><div class="post-content" id="post-content" itemprop="postContent"><p>开门见山地说，小程序在日常开发中使用原生框架来开发还是挺不方便的，比如：</p><ul><li>不支持 <code>npm</code> 包</li><li>不支持各种 <code>CSS</code> 预编译器</li><li>不支持配置 <code>Babel</code> 来转换一些 <code>JavaScript</code> 新特性</li></ul><p>这样一来和日常开发前端页面的体验相比来说，简直就像在<strong>刀耕火种</strong>。</p><blockquote><p>那么为了解决这些问题，我们能不能将前端开发中常用的 <code>webpack</code> 移植到小程序开发中呢？</p></blockquote><p><strong>当然可以！</strong></p><p><img width="200" height="200" src="https://webpack.js.org/assets/icon-square-big.svg"></p><h2 id="0-源码地址"><a href="#0-源码地址" class="headerlink" title="0.源码地址"></a>0.源码地址</h2><p><image src="https://img.shields.io/badge/webpack-%5E4.8.1-green.svg" alt="webpack version"></image></p><image src="https://img.shields.io/badge/vue--loader-%5E15.0.12-green.svg" alt="vue-loader version"><ul><li>在 <a href="(https://github.com/tuateam/tua-mp/tree/master/examples/webpack-simple/">webpack-simple</a>) 中文件结构和小程序相似。</li><li>而在 <a href="(https://github.com/tuateam/tua-mp/tree/master/examples/webpack-vue/">webpack-vue</a>) 中还增加了 <code>vue-loader</code>，因此你甚至还能利用 <code>.vue</code> 文件编写单文件组件。</li></ul><image src="/blog/imgs/tua-mp/logs.vue.png" width="400" alt="logs.vue"><h2 id="1-文件结构"><a href="#1-文件结构" class="headerlink" title="1.文件结构"></a>1.文件结构</h2><p>既然用 <code>webpack</code> 来编译源代码，那么很自然的我们的文件结构首先要分为 <code>src/</code> 和 <code>dist/</code>，用开发者工具打开的应该是 <code>dist/</code> 目录。</p><h3 id="1-1-src-中文件结构大概长这样："><a href="#1-1-src-中文件结构大概长这样：" class="headerlink" title="1.1.src/ 中文件结构大概长这样："></a>1.1.<code>src/</code> 中文件结构大概长这样：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app</span><br><span class="line">│   ├── app.js</span><br><span class="line">│   ├── app.json</span><br><span class="line">│   └── app.scss</span><br><span class="line">├── assets</span><br><span class="line">│   └── vue-logo.png</span><br><span class="line">├── comps</span><br><span class="line">│   └── todo</span><br><span class="line">│       ├── todo.js</span><br><span class="line">│       ├── todo.json</span><br><span class="line">│       ├── todo.less</span><br><span class="line">│       └── todo.wxml</span><br><span class="line">├── pages</span><br><span class="line">│   └── index</span><br><span class="line">│       ├── index.js</span><br><span class="line">│       ├── index.json</span><br><span class="line">│       ├── index.less</span><br><span class="line">│       └── index.wxml</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── const</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── index.js</span><br><span class="line">│   └── utils</span><br><span class="line">│       ├── README.md</span><br><span class="line">│       ├── event.js</span><br><span class="line">│       ├── format.js</span><br><span class="line">│       ├── index.js</span><br><span class="line">│       └── log.js</span><br><span class="line">├── styles</span><br><span class="line">│   ├── global.styl</span><br><span class="line">│   ├── todomvc-app-css.css</span><br><span class="line">│   └── todomvc-common-base.css</span><br><span class="line">└── templates</span><br><span class="line">    └── info.wxml</span><br></pre></td></tr></table></figure><ul><li>app/: 应用入口</li><li>assets/: 资源文件，比如图片</li><li>comps/: 组件</li><li>pages/: 页面</li><li>scripts: 公用代码</li><li>scripts/const: 常量（已配置别名 @const）</li><li>scripts/utils: 辅助函数（已配置别名 @utils）</li><li>styles/: 公用样式</li><li>templates/: 模板</li></ul><h3 id="1-2-dist-中文件结构大概长这样："><a href="#1-2-dist-中文件结构大概长这样：" class="headerlink" title="1.2.dist/ 中文件结构大概长这样："></a>1.2.<code>dist/</code> 中文件结构大概长这样：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app.js</span><br><span class="line">├── app.js.map</span><br><span class="line">├── app.json</span><br><span class="line">├── app.wxss</span><br><span class="line">├── assets</span><br><span class="line">│   └── vue-logo.png</span><br><span class="line">├── chunks</span><br><span class="line">│   ├── runtime.js</span><br><span class="line">│   ├── runtime.js.map</span><br><span class="line">│   ├── scripts.js</span><br><span class="line">│   ├── scripts.js.map</span><br><span class="line">│   ├── vendors.js</span><br><span class="line">│   └── vendors.js.map</span><br><span class="line">├── comps</span><br><span class="line">│   └── todo</span><br><span class="line">│       ├── todo.js</span><br><span class="line">│       ├── todo.js.map</span><br><span class="line">│       ├── todo.json</span><br><span class="line">│       ├── todo.wxml</span><br><span class="line">│       └── todo.wxss</span><br><span class="line">├── pages</span><br><span class="line">│   └── index</span><br><span class="line">│       ├── index.js</span><br><span class="line">│       ├── index.js.map</span><br><span class="line">│       ├── index.json</span><br><span class="line">│       ├── index.wxml</span><br><span class="line">│       └── index.wxss</span><br><span class="line">├── project.config.json</span><br><span class="line">└── templates</span><br><span class="line">    └── info.wxml</span><br></pre></td></tr></table></figure><ul><li>chunks/: 公共依赖<ul><li>runtime: <a href="https://doc.webpack-china.org/concepts/manifest/#runtime" target="_blank" rel="noopener">是 webapck 在运行时连接各个模块的代码</a></li><li>vendors: 是提取的 <code>node_modules</code> 下的依赖</li><li>scripts: 是提取的 <code>src/scripts/</code> 下的依赖</li></ul></li></ul><h3 id="1-3-整个项目文件结构大概长这样："><a href="#1-3-整个项目文件结构大概长这样：" class="headerlink" title="1.3.整个项目文件结构大概长这样："></a>1.3.整个项目文件结构大概长这样：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── dist/</span><br><span class="line">├── package.json</span><br><span class="line">├── project.config.json</span><br><span class="line">├── src/</span><br><span class="line">├── webpack.config.babel.js</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure><ul><li>src/: 源码</li><li>dist/: 打包后代码</li></ul><h2 id="2-webpack-基础配置"><a href="#2-webpack-基础配置" class="headerlink" title="2.webpack 基础配置"></a>2.webpack 基础配置</h2><h2 id="2-1-entry-output"><a href="#2-1-entry-output" class="headerlink" title="2.1.entry/output"></a>2.1.entry/output</h2><p>小程序场景下的配置应该是多入口，主要分为 <code>app</code>、<code>pages</code>、<code>comps</code> 这三类。</p><ul><li>app: 将 <code>src/app/</code> 下的文件编译成 <code>dist/</code> 根目录下的 <code>app.js/app.json/app.wxss</code></li><li>pages: <code>src/pages/ -&gt; dist/pages/</code></li><li>comps: <code>src/comps/ -&gt; dist/comps/</code></li></ul><p>在输出 <code>output</code> 部分有个坑：因为小程序使用的是 <code>global</code>，所以必须添加配置 <code>output.globalObject</code> 为 <code>global</code>。</p><blockquote><p>不然…</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">thirdScriptError VM937:<span class="number">1</span></span><br><span class="line"> sdk uncaught third <span class="built_in">Error</span></span><br><span class="line"> Cannot read property <span class="string">'webpackJsonp'</span> <span class="keyword">of</span> <span class="literal">undefined</span></span><br><span class="line"> <span class="built_in">TypeError</span>: Cannot read property <span class="string">'webpackJsonp'</span> <span class="keyword">of</span> <span class="literal">undefined</span></span><br><span class="line">    at http:<span class="comment">//127.0.0.1:40247/appservice/chunks/runtime.js:34:51</span></span><br><span class="line">    at http:<span class="comment">//127.0.0.1:40247/appservice/chunks/runtime.js:38:2</span></span><br><span class="line">    at <span class="built_in">require</span> (http:<span class="comment">//127.0.0.1:40247/appservice/__dev__/WAService.js:19:7859)</span></span><br><span class="line">    at http:<span class="comment">//127.0.0.1:40247/appservice/__dev__/WAService.js:19:7573</span></span><br><span class="line">    at http:<span class="comment">//127.0.0.1:40247/appservice/app.js:3:1</span></span><br><span class="line">    at <span class="built_in">require</span> (http:<span class="comment">//127.0.0.1:40247/appservice/__dev__/WAService.js:19:7859)</span></span><br><span class="line">    at http:<span class="comment">//127.0.0.1:40247/appservice/appservice?t=1527755092895:1020:9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// runtime</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="built_in">window</span>.webpackJsonp = <span class="built_in">window</span>.webpackJsonp || []</span><br></pre></td></tr></table></figure><p><a href="https://github.com/webpack/webpack/pull/6200" target="_blank" rel="noopener">详情可参阅这个 pr</a></p><blockquote><p>ps 在 mpvue 中似乎是通过修改 target 实现的… <a href="http://mpvue.com/build/mpvue-webpack-target/" target="_blank" rel="noopener">http://mpvue.com/build/mpvue-webpack-target/</a></p></blockquote><h2 id="2-2-CommonChunk"><a href="#2-2-CommonChunk" class="headerlink" title="2.2.CommonChunk"></a>2.2.CommonChunk</h2><p>在 webpack 4 中有一个 breaking change，<a href="https://medium.com/webpack/webpack-4-code-splitting-chunk-graph-and-the-splitchunks-optimization-be739a861366" target="_blank" rel="noopener">即使用 <code>SplitChunksPlugin</code> 替换了之前很常用的 <code>CommonsChunkPlugin</code></a></p><p>主要提取了三部分的公共代码：</p><ul><li>runtime: <a href="https://doc.webpack-china.org/concepts/manifest/#runtime" target="_blank" rel="noopener">是 webapck 在运行时连接各个模块的代码</a></li><li>vendors: 是提取的 <code>node_modules</code> 下的依赖</li><li>scripts: 是提取的 <code>src/scripts/</code> 下的依赖</li></ul><blockquote><p>现在又碰到个新的问题：如何引入这些 <code>chunks</code>？</p></blockquote><p>在前端项目中一般我们通过 <code>HtmlWebpackPlugin</code> 插件在 html 文件中添加 <code>&lt;script&gt;</code> 标签引入，然鹅小程序中并没有 html 文件…</p><blockquote><p>计将安出？</p></blockquote><p>总不能每次都手动去 <code>dist/app.js</code> 中 require 这些文件吧？</p><p>这时候就要介绍另一款插件了~：<code>BannerPlugin</code>。</p><p>这个插件本来是用在文件头部添加 banner 的，但是也支持插入代码，因此利用这款插件我们就可以将这些公共依赖在 <code>app.js</code> 中统一引入一次即可。</p><blockquote><p>TODO: 现版本的小程序提供了分包加载能力，因此这里还有优化空间</p></blockquote><h2 id="2-3-CopyWebpackPlugin"><a href="#2-3-CopyWebpackPlugin" class="headerlink" title="2.3.CopyWebpackPlugin"></a>2.3.CopyWebpackPlugin</h2><p>顾名思义，这款插件的用处就是拷贝，利用这款插件我们就可以实现：</p><ul><li>复制 <code>project.config.json</code></li><li>复制 <code>*.json</code></li><li>复制 <code>*.wxml</code></li><li>复制 <code>*.wxss</code></li><li>复制 <code>assets/</code></li><li>复制 <code>templates/</code></li></ul><p>在使用时有一个知识点可以减少代码量：即 <code>context</code> 选项，这样就不用写 n 个 <code>src/</code>了…</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CopyWebpackPlugin(copyCfgArr, &#123;</span><br><span class="line">    context: resolve(<span class="string">'src'</span>),</span><br><span class="line">&#125;),</span><br></pre></td></tr></table></figure><h2 id="2-4-预处理器和-CSS-的处理"><a href="#2-4-预处理器和-CSS-的处理" class="headerlink" title="2.4.预处理器和 CSS 的处理"></a>2.4.预处理器和 CSS 的处理</h2><p>这部分其实都是常规操作和一般 web 开发没啥区别，配置好对应的 loader 即可。</p><p>需要注意的点就是一定要使用 <code>ExtractTextWebpackPlugin</code> 插件来生成 <code>.wxss</code> 文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ExtractTextPlugin(<span class="string">'[name].wxss'</span>)</span><br></pre></td></tr></table></figure><h2 id="3-webpack-vue-loader"><a href="#3-webpack-vue-loader" class="headerlink" title="3.webpack + vue-loader"></a>3.webpack + vue-loader</h2><p>这部分谈谈如何利用 <code>vue-loader</code> 实现在小程序中引用单文件组件（<code>.vue</code>）。</p><p>先看看 <code>src/</code> 下的文件结构：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app</span><br><span class="line">│   ├── App.vue</span><br><span class="line">│   ├── app.js</span><br><span class="line">│   └── app.json</span><br><span class="line">├── assets</span><br><span class="line">│   └── vue-logo.png</span><br><span class="line">├── comps</span><br><span class="line">│   ├── filter</span><br><span class="line">│   │   ├── Filter.vue</span><br><span class="line">│   │   └── index.js</span><br><span class="line">│   └── todo</span><br><span class="line">│       ├── Todo.vue</span><br><span class="line">│       └── index.js</span><br><span class="line">├── pages</span><br><span class="line">│   ├── index</span><br><span class="line">│   │   ├── Index.vue</span><br><span class="line">│   │   └── index.js</span><br><span class="line">│   └── todos</span><br><span class="line">│       ├── Todos.vue</span><br><span class="line">│       └── index.js</span><br><span class="line">├── scripts</span><br><span class="line">│   ├── const</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── index.js</span><br><span class="line">│   └── utils</span><br><span class="line">│       ├── README.md</span><br><span class="line">│       ├── event.js</span><br><span class="line">│       ├── format.js</span><br><span class="line">│       ├── index.js</span><br><span class="line">│       └── log.js</span><br><span class="line">├── styles</span><br><span class="line">│   ├── global.styl</span><br><span class="line">│   ├── todomvc-app-css.css</span><br><span class="line">│   └── todomvc-common-base.css</span><br><span class="line">└── templates</span><br><span class="line">    └── info.wxml</span><br></pre></td></tr></table></figure><p>其实已经和一般的 web 项目很相似了~</p><h3 id="3-1-vue-loader-v15"><a href="#3-1-vue-loader-v15" class="headerlink" title="3.1.vue-loader v15?"></a>3.1.vue-loader v15?</h3><p>随着 webpack 升级到了 v4，官方与之配合的 <code>vue-loader</code> 也升级到了 v15。</p><blockquote><p>现在 Vue Loader 15 使用了一个不一样的策略来推导语言块使用的 loader。</p></blockquote><blockquote><p>在 v15 中，<code>&lt;style lang=&quot;less&quot;&gt;</code> 会完成把它当作一个真实的 <code>*.less</code> 文件来加载。因此，为了这样处理它，你需要在你的主 webpack 配置中显式地提供一条规则。</p></blockquote><p>简单来说就是咱们之前配置过的各个预处理器规则会被 <code>vue-loader</code> 自动使用。</p><p>因此我们只需要简单地添加一条规则即可读取 <code>.vue</code> 文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">    exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">    loader: <span class="string">'vue-loader'</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">        compiler: &#123;</span><br><span class="line">            <span class="comment">// mock vue-template-compiler</span></span><br><span class="line">            compile: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">                staticRenderFns: [],</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><blockquote><p><code>options.compiler</code> 是啥？</p></blockquote><h3 id="3-2-options-compiler"><a href="#3-2-options-compiler" class="headerlink" title="3.2.options.compiler"></a>3.2.options.compiler</h3><p><a href="https://vue-loader.vuejs.org/zh/options.html#compiler" target="_blank" rel="noopener">options.compiler 覆写用来编译单文件组件中 <code>&lt;template&gt;</code> 块的默认编译器。</a></p><p>在实际使用单文件组件时，我们通过 <code>&lt;template lang=&quot;wxml&quot;&gt;</code> 来包裹原本的 <code>.wxml</code> 文件中的内容。</p><p>因为最终要编译成 <code>.wxml</code> 文件才能被开发者工具识别，所以我们还编写了一条规则通过 <code>file-loader</code> 生成最终的 <code>.wxml</code> 文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;template lang="wxml"&gt;&#123;...&#125;&lt;/template&gt;</span></span><br><span class="line">    <span class="comment">// 生成 .wxml 文件</span></span><br><span class="line">    test: <span class="regexp">/\.wxml$/</span>,</span><br><span class="line">    use: &#123;</span><br><span class="line">        loader: <span class="string">'file-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">            name: getNameByFilePathAndExt(<span class="string">'.wxml'</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>但是因为 <code>vue-loader</code> 默认会编译 template 中的内容将其生成一个个 render 函数。但其实在小程序场景中我们并不需要这一步骤。我们只想安安静静地将这些代码通过 <code>file-loader</code> 生成 <code>.wxml</code> 文件…</p><p>幸好 <code>vue-loader</code> 还提供了 <code>options.compiler</code> 这个参数用来传递自己的编译器。所以这里其实是 mock 了一下 <code>vue-template-compiler</code>。</p><h3 id="3-3-Custom-Blocks"><a href="#3-3-Custom-Blocks" class="headerlink" title="3.3.Custom Blocks"></a>3.3.Custom Blocks</h3><blockquote><p>最后还有个问题没有解决：如何处理 <code>.json</code> 文件？</p></blockquote><p>在其他的小程序框架中是这样处理的：</p><ul><li>在 <code>wepy</code> 中将其作为组件的 <code>config</code> 属性</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">wepy</span>.<span class="title">page</span> </span>&#123;</span><br><span class="line">    <span class="comment">//页面配置</span></span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="string">"navigationBarTitleText"</span>: <span class="string">"test"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在 <code>mpvue</code> 中是写在 <code>main.js</code> 的输出部分</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// 这个字段走 app.json</span></span><br><span class="line">  config: &#123;</span><br><span class="line">    <span class="comment">// 页面前带有 ^ 符号的，会被编译成首页，其他页面可以选填，我们会自动把 webpack entry 里面的入口页面加进去</span></span><br><span class="line">    pages: [<span class="string">'pages/logs/main'</span>, <span class="string">'^pages/index/main'</span>],</span><br><span class="line">    <span class="built_in">window</span>: &#123;</span><br><span class="line">      backgroundTextStyle: <span class="string">'light'</span>,</span><br><span class="line">      navigationBarBackgroundColor: <span class="string">'#fff'</span>,</span><br><span class="line">      navigationBarTitleText: <span class="string">'WeChat'</span>,</span><br><span class="line">      navigationBarTextStyle: <span class="string">'black'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/pages/logs/main.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  config: &#123;</span><br><span class="line">    navigationBarTitleText: <span class="string">'查看启动日志'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>tua-mp</code> 中目前采用的是自定义块的方式来实现的，即在 <code>.vue</code> 文件中新增了一个 <code>&lt;config&gt;</code> 块来编写配置。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">  "navigationBarTitleText": "查看启动日志"</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">lang</span>=<span class="string">"wxml"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是并没有将 <code>app.json</code> 的内容放到 <code>App.vue</code> 中，因为有时需要读取这里的页面配置。如果写到 <code>&lt;config&gt;</code> 中的话，就无法读取了…</p><blockquote><p>例如为了实现从分享后的页面后退返回首页这个功能，在辅助函数中就需要读取页面和 tabBar 配置，生成分享链接（实际分享地址是首页，然后从首页再导航到被分享的页面）。</p></blockquote><p>因此最优解是页面配置写在 <code>&lt;config&gt;</code> 中，应用配置写在 <code>app.js</code> 的输出中。</p><blockquote><p>TODO: 实现 mpvue 的方式处理 <code>app.json</code></p></blockquote><p>具体的配置如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;config&gt;&#123;...&#125;&lt;/config&gt; 代码块</span></span><br><span class="line">    <span class="comment">// 生成 .json 文件</span></span><br><span class="line">    resourceQuery: <span class="regexp">/blockType=config/</span>,</span><br><span class="line">    use: &#123;</span><br><span class="line">        loader: <span class="string">'file-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">            name: getNameByFilePathAndExt(<span class="string">'.json'</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h2><p>综上，咱们在 <code>webpack v4</code> 和 <code>vue-loader v15</code> 的帮助下，让小程序拥有了以下能力：</p><ul><li>加载 npm 包</li><li>提取 CommonChunk 减少打包体积</li><li>babel 编译 JavaScript 代码</li><li>支持 less/sass/stylus 等预处理器</li><li>单文件组件</li></ul><blockquote><p>不过话又说回来了…</p></blockquote><blockquote><p>原生的小程序…又不是不能用~</p></blockquote><image src="/blog/imgs/tua-mp/又不是不能用.jpg" width="400" alt="又不是不能用"><blockquote><p>注：这句话是黄章说的，Teacher Luo 没说过这话哟~</p></blockquote><p>以上 to be continued…</p></image></image></image><blockquote><p>本文地址： <a href="https://buptsteve.github.io/blog/2018/06/03/12.say-goodbye-to-mina-native/" target="_blank" rel="external">https://buptsteve.github.io/blog/2018/06/03/12.say-goodbye-to-mina-native/</a></p><footer><cite><a href="https://buptsteve.github.io/blog">@BuptStEve's Blog</a></cite></footer></blockquote></div><nav class="post-nav"><div class="waves-block waves-effect next fr"><a href="/blog/2018/05/21/11.say-goodbye-to-mina-setData/" id="post-next" class="post-nav-link"><div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">「11」小程序之告别 setData</h4></a></div></nav><div class="duoshuo"><div class="ds-thread" data-thread-key="12.say-goodbye-to-mina-native" data-title="「12」小程序之告别“刀耕火种”" data-url="https://buptsteve.github.io/blog/2018/06/03/12.say-goodbye-to-mina-native/index.html"></div><script>var duoshuoQuery={short_name:"buptsteve"};!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//static.duoshuo.com/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()</script></div></div></div></article></div></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><script src="/blog/js/wave.min.js"></script><script src="/blog/js/main.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><script type="text/template" id="search-tpl"><li class="item">
        <a href="/{path}" class="waves-block waves-effect">
            <div class="title ellipsis" title="{title}">{title}</div>
            
            <div class="flex-row flex-middle">
                <div class="tags ellipsis">
                    {tags}
                </div>

                <time class="flex-col time">{date}</time>
            </div>
        </a>
    </li></script><script src="/blog/js/search.js"></script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-85691829-1","auto"),ga("send","pageview")</script></body></html>