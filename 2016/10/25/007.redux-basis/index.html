<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="keywords" content=""><meta name="theme-color" content="#3F51B5"><meta name="summary" content="BuptStEve"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>「7」Redux 基础 - react 全家桶学习笔记（一） | BuptStEve&#39;s Blog | Talk is cheap show me the offer!</title><meta name="description" content="零、环境搭建参考资料  英文原版文档 中文文档 墙裂推荐作者出的教学视频 基础篇 墙裂推荐作者出的教学视频 高级篇  首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react 进行学习，这样可以避免一开始就陷入各种细节之中。 所以推荐使用 jsbin 进行调试学习，或者使用 create-react-app 作为项目脚手架。 一、Redux 是什么？ R"><meta name="keywords" content="JavaScript,Redux,React"><meta property="og:type" content="article"><meta property="og:title" content="「7」Redux 基础 - react 全家桶学习笔记（一）"><meta property="og:url" content="https://buptsteve.github.io/blog/2016/10/25/007.redux-basis/index.html"><meta property="og:site_name" content="BuptStEve&#39;s Blog"><meta property="og:description" content="零、环境搭建参考资料  英文原版文档 中文文档 墙裂推荐作者出的教学视频 基础篇 墙裂推荐作者出的教学视频 高级篇  首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react 进行学习，这样可以避免一开始就陷入各种细节之中。 所以推荐使用 jsbin 进行调试学习，或者使用 create-react-app 作为项目脚手架。 一、Redux 是什么？ R"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://buptsteve.github.io/blog/imgs/redux/overview.png"><meta property="og:updated_time" content="2016-10-26T10:29:47.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="「7」Redux 基础 - react 全家桶学习笔记（一）"><meta name="twitter:description" content="零、环境搭建参考资料  英文原版文档 中文文档 墙裂推荐作者出的教学视频 基础篇 墙裂推荐作者出的教学视频 高级篇  首先要明确一点，虽然 redux 是由 flux 演变而来，但我们完全可以并且也应该抛开 react 进行学习，这样可以避免一开始就陷入各种细节之中。 所以推荐使用 jsbin 进行调试学习，或者使用 create-react-app 作为项目脚手架。 一、Redux 是什么？ R"><meta name="twitter:image" content="https://buptsteve.github.io/blog/imgs/redux/overview.png"><link rel="shortcut icon" href="/blog/img/favicon.ico"><link rel="stylesheet" href="/blog/css/style.css"><link rel="alternative" href="/blog/atom.xml" title="BuptStEve&#39;s Blog" type="application/atom+xml"></head><body><div id="loading" class="active"></div><nav id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap"><div class="brand"><a href="/blog" class="avatar"><img src="/blog/img/logo.jpg"></a><hgroup class="introduce"><h5 class="nickname">Steve Young</h5><a href="mailto:yangzhenyu2016@gmail.com" title="yangzhenyu2016@gmail.com" class="mail">yangzhenyu2016@gmail.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/blog/"><i class="icon icon-lg icon-home"></i> 主页</a></li><li class="waves-block waves-effect"><a href="/blog/archives"><i class="icon icon-lg icon-archives"></i> Archives</a></li><li class="waves-block waves-effect"><a href="/blog/tags"><i class="icon icon-lg icon-tags"></i> Tags</a></li><li class="waves-block waves-effect"><a href="https://github.com/buptsteve" target="_blank"><i class="icon icon-lg icon-github"></i> Github</a></li><li class="waves-block waves-effect"><a href="http://weibo.com/0osteveyoungo0" target="_blank"><i class="icon icon-lg icon-weibo"></i> Weibo</a></li></ul><footer class="footer"><p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC"></a></p><p>BuptStEve&#39;s Blog &copy; 2019</p><p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p><a href="/blog/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a></footer></div></div></nav><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">「7」Redux 基础 - react 全家桶学习笔记（一）</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i></a> <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div></div></header><header class="content-header"><div class="container"><h1 class="author">「7」Redux 基础 - react 全家桶学习笔记（一）</h1><h5 class="subtitle"><time datetime="2016-10-25T15:00:35.000Z" itemprop="datePublished" class="page-time">2016-10-25</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/blog/categories/前端/">前端</a></li></ul></h5></div></header><div class="container body-wrap"><article id="post-007.redux-basis" class="article article-type-post" itemprop="blogPost"><div class="post-meta flex-row"><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/React/">React</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Redux/">Redux</a></li></ul></div><div class="post-body"><aside class="post-widget" id="post-widget"><nav class="post-toc-wrap" id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#零、环境搭建"><span class="post-toc-text">零、环境搭建</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一、Redux-是什么？"><span class="post-toc-text">一、Redux 是什么？</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1-为什么选择-redux？"><span class="post-toc-text">1.1. 为什么选择 redux？</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-三大原则（哲♂学）"><span class="post-toc-text">1.2. 三大原则（哲♂学）</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2-1-单一数据源（Single-source-of-truth）"><span class="post-toc-text">1.2.1. 单一数据源（Single source of truth）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2-2-State-是只读的（State-is-read-only）"><span class="post-toc-text">1.2.2. State 是只读的（State is read-only）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）"><span class="post-toc-text">1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二、Redux-基础"><span class="post-toc-text">二、Redux 基础</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-action"><span class="post-toc-text">2.1. action</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-reducer"><span class="post-toc-text">2.2. reducer</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-store"><span class="post-toc-text">2.3. store</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-3-1-getState"><span class="post-toc-text">2.3.1. getState</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-3-2-dispatch-action"><span class="post-toc-text">2.3.2. dispatch(action)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-3-3-subscribe-listener"><span class="post-toc-text">2.3.3. subscribe(listener)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-3-4-replaceReducer-nextReducer"><span class="post-toc-text">2.3.4. replaceReducer(nextReducer)</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-4-createStore"><span class="post-toc-text">2.4. createStore</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-5-计数器例子"><span class="post-toc-text">2.5. 计数器例子</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#三、与-React-进行结合"><span class="post-toc-text">三、与 React 进行结合</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-通过-script-标签导入-react"><span class="post-toc-text">3.1. 通过 script 标签导入 react</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-用-Redux-和-React-实现-TodoApp"><span class="post-toc-text">3.2. 用 Redux 和 React 实现 TodoApp</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2-1-分析与设计"><span class="post-toc-text">3.2.1. 分析与设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#1-容器组件-V-S-展示组件"><span class="post-toc-text">1. 容器组件 V.S. 展示组件</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#2-应用设计"><span class="post-toc-text">2. 应用设计</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-2-2-编码实现"><span class="post-toc-text">3.2.2. 编码实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#1-action-部分"><span class="post-toc-text">1. action 部分</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#2-reducer-部分"><span class="post-toc-text">2. reducer 部分</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#3-view-部分"><span class="post-toc-text">3. view 部分</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#1-只有根组件"><span class="post-toc-text">1. 只有根组件</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#2-组件拆分"><span class="post-toc-text">2. 组件拆分</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#3-增加容器组件"><span class="post-toc-text">3. 增加容器组件</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#4-Provider"><span class="post-toc-text">4. Provider</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#5-connect"><span class="post-toc-text">5. connect</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#四、总结"><span class="post-toc-text">四、总结</span></a></li></ol></nav></aside><div class="post-main"><div class="post-content" id="post-content" itemprop="postContent"><h2 id="零、环境搭建"><a href="#零、环境搭建" class="headerlink" title="零、环境搭建"></a>零、环境搭建</h2><p><strong>参考资料</strong></p><ul><li><a href="http://redux.js.org/" target="_blank" rel="noopener">英文原版文档</a></li><li><a href="http://cn.redux.js.org/" target="_blank" rel="noopener">中文文档</a></li><li><a href="https://egghead.io/courses/getting-started-with-redux" target="_blank" rel="noopener">墙裂推荐作者出的教学视频 基础篇</a></li><li><a href="https://egghead.io/courses/building-react-applications-with-idiomatic-redux" target="_blank" rel="noopener">墙裂推荐作者出的教学视频 高级篇</a></li></ul><p>首先要明确一点，虽然 redux 是由 <a href="http://facebook.github.io/flux/" target="_blank" rel="noopener">flux</a> 演变而来，但我们完全可以并且也应该抛开 react 进行学习，这样可以避免一开始就陷入各种细节之中。</p><p>所以推荐使用 <a href="https://jsbin.com/" target="_blank" rel="noopener">jsbin</a> 进行调试学习，或者使用 <a href="https://github.com/facebookincubator/create-react-app" target="_blank" rel="noopener">create-react-app</a> 作为项目脚手架。</p><h2 id="一、Redux-是什么？"><a href="#一、Redux-是什么？" class="headerlink" title="一、Redux 是什么？"></a>一、Redux 是什么？</h2><blockquote><p>Redux is a predictable state container for JavaScript apps.<br>Redux 是一个 JavaScript 状态容器，提供可预测化的状态管理。</p></blockquote><p><img src="/blog/imgs/redux/overview.png" alt="overview"></p><p><strong>先不要在意那些细节</strong></p><ul><li>总的来说，redux 使用 store 保存并管理页面中的各种状态（state）</li><li>当需要改变 state 时，使用 dispatch 调用 action creators 触发 action</li><li>接着使用纯函数（pure function）reducer 来处理这些 action，它会根据当前 state 和 action 返回（注意这里不是修改）新的 state</li><li>view 层可以对于 state 进行订阅（subscribe），这样就可以得到新的 state，从而可以刷新界面（所以十分适合数据驱动的前端框架）</li></ul><blockquote><p>纯函数：简单的说就是对于同样的输入总是返回同样的输出，并且没有副作用的函数。（推荐学习了解下函数式编程）</p></blockquote><h3 id="1-1-为什么选择-redux？"><a href="#1-1-为什么选择-redux？" class="headerlink" title="1.1. 为什么选择 redux？"></a>1.1. 为什么选择 redux？</h3><blockquote><ul><li>随着 JavaScript 单页应用开发日趋复杂，JavaScript 需要管理比任何时候都要多的 state （状态）。 这些 state 可能包括服务器响应、缓存数据、本地生成尚未持久化到服务器的数据，也包括 UI 状态，如激活的路由，被选中的标签，是否显示加载动效或者分页器等等。</li></ul></blockquote><blockquote><ul><li>管理不断变化的 state 非常困难。如果一个 model 的变化会引起另一个 model 变化，那么当 view 变化时，就可能引起对应 model 以及另一个 model 的变化，依次地，可能会引起另一个 view 的变化。直至你搞不清楚到底发生了什么。state 在什么时候，由于什么原因，如何变化已然不受控制。 当系统变得错综复杂的时候，想重现问题或者添加新功能就会变得举步维艰。</li></ul></blockquote><blockquote><ul><li>如果这还不够糟糕，考虑一些来自前端开发领域的新需求，如更新调优、服务端渲染、路由跳转前请求数据等等。前端开发者正在经受前所未有的复杂性，难道就这么放弃了吗？当然不是。</li></ul></blockquote><blockquote><ul><li>这里的复杂性很大程度上来自于：我们总是将两个难以厘清的概念混淆在一起：<strong>变化</strong>和<strong>异步</strong>。 我称它们为曼妥思和可乐。如果把二者分开，能做的很好，但混到一起，就变得一团糟。一些库如 React 试图在视图层禁止异步和直接操作 DOM 来解决这个问题。美中不足的是，React 依旧把处理 state 中数据的问题留给了你。Redux就是为了帮你解决这个问题。</li></ul></blockquote><blockquote><ul><li>跟随 Flux、CQRS 和 Event Sourcing 的脚步，通过限制更新发生的时间和方式，Redux 试图让 state 的变化变得可预测。这些限制条件反映在 Redux 的 三大原则中。</li></ul></blockquote><p><strong>简单总结就是使用 Redux 我们就可以<del>没有蛀牙（大雾）</del></strong></p><ul><li>拥有可预测（predictable）的应用状态，所以应用的行为也是可预测的</li><li>因为 reducer 是纯函数，所以方便对于状态迁移进行自动化测试</li><li>方便地记录日志，甚至实现时间旅行（time travel）</li></ul><h3 id="1-2-三大原则（哲♂学）"><a href="#1-2-三大原则（哲♂学）" class="headerlink" title="1.2. 三大原则（哲♂学）"></a>1.2. 三大原则（哲♂学）</h3><h4 id="1-2-1-单一数据源（Single-source-of-truth）"><a href="#1-2-1-单一数据源（Single-source-of-truth）" class="headerlink" title="1.2.1. 单一数据源（Single source of truth）"></a>1.2.1. 单一数据源（Single source of truth）</h4><p>整个应用的 state 被储存在一棵 object tree 中，并且这个 object tree 只存在于唯一一个 store 中。</p><ul><li>来自服务端的 state 可以在无需编写更多代码的情况下被序列化并注入到客户端中</li><li>便于调试，在开发时可以将状态保存在本地</li><li>Undo/Redo 可以轻松实现，从而实现时间旅行</li></ul><h4 id="1-2-2-State-是只读的（State-is-read-only）"><a href="#1-2-2-State-是只读的（State-is-read-only）" class="headerlink" title="1.2.2. State 是只读的（State is read-only）"></a>1.2.2. State 是只读的（State is read-only）</h4><p>惟一改变 state 的方法就是触发 action，action 是一个用于描述已发生事件的普通对象。</p><p>因为所有的修改都被集中化处理，且严格按照一个接一个的顺序执行，（dispatch 同步调用 reduce 函数）因此不用担心 race condition 的出现。 Action 就是普通对象而已，因此它们可以被日志打印、序列化、储存、后期调试或测试时回放出来。</p><h4 id="1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）"><a href="#1-2-3-使用纯函数来执行修改（Changes-are-made-with-pure-functions）" class="headerlink" title="1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）"></a>1.2.3. 使用纯函数来执行修改（Changes are made with pure functions）</h4><p>为了描述 action 如何改变 state tree ，你需要编写 reducer。</p><p>Reducer 只是纯函数，它接收先前的 state 和 action，并返回新的 state。刚开始你可以只有一个 reducer，随着应用变大，你可以把它拆成多个小的 reducers，分别独立地操作 state tree 的不同部分。</p><h2 id="二、Redux-基础"><a href="#二、Redux-基础" class="headerlink" title="二、Redux 基础"></a>二、Redux 基础</h2><h3 id="2-1-action"><a href="#2-1-action" class="headerlink" title="2.1. action"></a>2.1. action</h3><p>Action 就是一个普通的 JavaScript Object。</p><p>redux 唯一限制的一点是必须有一个 type 属性用来表示执行哪种操作，值最好用字符串，而不是 Symbols，因为字符串是可被序列化的。</p><p>其他属性用来传递此次操作所需传递的数据，redux 对此不作限制，但是在设计时可以参照 <a href="https://github.com/acdlite/flux-standard-action" target="_blank" rel="noopener">Flux 标准 Action</a>。</p><p><strong>简单总结 Flux Standard action 就是</strong></p><blockquote><ol><li>一个 action 必须是一个 JavaScript Object，并且有一个 type 属性。</li><li>一个 action 可以有 payload/error/meta 属性。</li><li>一个 action 不能有其他属性。</li></ol></blockquote><h3 id="2-2-reducer"><a href="#2-2-reducer" class="headerlink" title="2.2. reducer"></a>2.2. reducer</h3><p>Reducer 的工作就是接收旧的 state 和 action，返回新的 state。</p><blockquote><p>(previousState, action) =&gt; newState</p></blockquote><p>之所以称作 reducer 是因为它将被传递给 <code>Array.prototype.reduce(reducer, ?initialValue)</code> 方法。保持 reducer 纯净非常重要。永远不要在 reducer 里做这些操作：</p><ul><li>修改传入参数；</li><li>执行有副作用的操作，如 API 请求和路由跳转；</li><li>调用非纯函数，如 Date.now() 或 Math.random()。</li></ul><h3 id="2-3-store"><a href="#2-3-store" class="headerlink" title="2.3. store"></a>2.3. store</h3><p>Store 就是用来维持应用所有的 state 树的一个对象。</p><p>在 redux 中只有一个 store（区别于 flux 的多个 store），在 store 中保存所有的 state，可以把它当成一个封装了 state 的类。而除了对其 dispatch 一个 action 以外无法改变内部的 state。</p><p>在实际操作中我们只需要把根部的 reducer 函数传递给 createStore 就可以得到一个 store。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'SOME_ACTION'</span>:</span><br><span class="line">            <span class="comment">// 一些操作</span></span><br><span class="line">            <span class="keyword">return</span> newState; <span class="comment">// 返回新状态</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(reducer);</span><br></pre></td></tr></table></figure><p><strong>redux 中提供了这几个 api 操作 store</strong></p><h4 id="2-3-1-getState"><a href="#2-3-1-getState" class="headerlink" title="2.3.1. getState"></a>2.3.1. getState</h4><p>返回当前的整个 state 树。</p><h4 id="2-3-2-dispatch-action"><a href="#2-3-2-dispatch-action" class="headerlink" title="2.3.2. dispatch(action)"></a>2.3.2. dispatch(action)</h4><p>分发 action 给对应的 reducer。</p><p>该函数会调用 getState() 和传入的 action 以【同步】的方式调用 store 的 reduce 函数，然后返回新的 state。从而 state 得到了更新，并且变化监听器（change listener）会被触发。（对于异步操作则将其放到了 action creator 这个步骤）</p><h4 id="2-3-3-subscribe-listener"><a href="#2-3-3-subscribe-listener" class="headerlink" title="2.3.3. subscribe(listener)"></a>2.3.3. subscribe(listener)</h4><p>为 store 添加一个变化监听器，每当 dispatch 的时候就会执行，你可以在 listener（回调函数）中使用 getState() 来得到当前的 state。</p><p>这个 api 设计的挺有意思，它会返回一个函数，而你执行这个函数后就可以取消订阅。</p><h4 id="2-3-4-replaceReducer-nextReducer"><a href="#2-3-4-replaceReducer-nextReducer" class="headerlink" title="2.3.4. replaceReducer(nextReducer)"></a>2.3.4. replaceReducer(nextReducer)</h4><p>替换 store 当前用来计算 state 的 reducer。</p><p>这是一个高级 API。只有在你需要实现代码分隔，而且需要立即加载一些 reducer 的时候才可能会用到它。在实现 Redux 热加载机制的时候也可能会用到。</p><h3 id="2-4-createStore"><a href="#2-4-createStore" class="headerlink" title="2.4. createStore"></a>2.4. createStore</h3><p>忽略各种类型判断，实现一个最简的 createStore 可以用以下代码。<a href="https://egghead.io/lessons/javascript-redux-implementing-store-from-scratch" target="_blank" rel="noopener">参考资料</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStore = <span class="function">(<span class="params">reducer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> state;</span><br><span class="line">    <span class="keyword">let</span> listeners = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getState = <span class="function"><span class="params">()</span> =&gt;</span> state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dispatch = <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">        state = reducer(state, action); <span class="comment">// 调用 reducer</span></span><br><span class="line">        listeners.forEach(<span class="function"><span class="params">listener</span> =&gt;</span> listener()); <span class="comment">// 调用所有变化监听器</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> subscribe = <span class="function">(<span class="params">listener</span>) =&gt;</span> &#123;</span><br><span class="line">        listeners.push(listener);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 返回解除监听函数</span></span><br><span class="line">            listeners = listeners.filter(<span class="function"><span class="params">l</span> =&gt;</span> l !== listener);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dispatch(&#123;&#125;); <span class="comment">// 初始化</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; getState, dispatch, subscribe &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="2-5-计数器例子"><a href="#2-5-计数器例子" class="headerlink" title="2.5. 计数器例子"></a>2.5. 计数器例子</h3><ul><li><p>纯 JavaScript 不涉及界面（可以在右侧 console 中尝试 store.dispatch）</p><iframe src="http://jsbin.com/kejezih/edit?js,console" width="100%" height="600" frameborder="0" allowfullscreen></iframe></li><li><p>增加界面</p><iframe src="http://jsbin.com/jihara/edit?html,js,output" width="100%" height="600" frameborder="0" allowfullscreen></iframe></li></ul><h2 id="三、与-React-进行结合"><a href="#三、与-React-进行结合" class="headerlink" title="三、与 React 进行结合"></a>三、与 React 进行结合</h2><h3 id="3-1-通过-script-标签导入-react"><a href="#3-1-通过-script-标签导入-react" class="headerlink" title="3.1. 通过 script 标签导入 react"></a>3.1. 通过 script 标签导入 react</h3><p>实现同样功能的 Counter</p><iframe src="http://jsbin.com/qalevu/edit?html,js,output" width="100%" height="800" frameborder="0" allowfullscreen></iframe><h3 id="3-2-用-Redux-和-React-实现-TodoApp"><a href="#3-2-用-Redux-和-React-实现-TodoApp" class="headerlink" title="3.2. 用 Redux 和 React 实现 TodoApp"></a>3.2. 用 Redux 和 React 实现 TodoApp</h3><p>在添加 react-redux 之前，为了体会下 react-redux 的作用，首先来实现一个比计数器更复杂一点儿的 TodoApp 栗子~</p><h4 id="3-2-1-分析与设计"><a href="#3-2-1-分析与设计" class="headerlink" title="3.2.1. 分析与设计"></a>3.2.1. 分析与设计</h4><h5 id="1-容器组件-V-S-展示组件"><a href="#1-容器组件-V-S-展示组件" class="headerlink" title="1. 容器组件 V.S. 展示组件"></a>1. 容器组件 V.S. 展示组件</h5><p><strong>组件一般分为</strong></p><ul><li>容器组件（Smart/Container Components）</li><li>展示组件（Dumb/Presentational Components）</li></ul><table><thead><tr><th></th><th>容器组件</th><th>展示组件</th></tr></thead><tbody><tr><td>Location</td><td>最顶层，路由处理</td><td>中间和子组件</td></tr><tr><td>Aware of Redux</td><td>是</td><td>否</td></tr><tr><td>读取数据</td><td>从 Redux 获取 state</td><td>从 props 获取数据</td></tr><tr><td>修改数据</td><td>向 Redux 派发 actions</td><td>从 props 调用回调函数</td></tr></tbody></table><p>最佳实践一般是由容器组件负责一些数据的获取，进行 dispatch 等操作。而展示组件组件不应该关心逻辑，所有数据都通过 props 传入。</p><p>这样才能达到展示组件可以在多处复用，在具体复用时就是通过容器组件将其包装，为其提供所需的各种数据。</p><h5 id="2-应用设计"><a href="#2-应用设计" class="headerlink" title="2. 应用设计"></a>2. 应用设计</h5><ul><li><p>一个 TodoApp 包含了三个部分：</p><ul><li>顶部的 AddTodo 输入部分</li><li>中间的 TodoList 展示部分</li><li>底部的 Footer 过滤部分</li></ul></li><li><p>State 应该包含：</p><ul><li>filter：过滤 todos 的条件<ul><li>SHOW_ALL</li><li>SHOW_ACTIVE</li><li>SHOW_COMPLETED</li></ul></li><li>todos：所有的 todo<ul><li>todo：包含 id、text 和 completed</li></ul></li></ul></li><li><p>然而传到应用中的 props 只需要：</p><ul><li>visibleTodos：过滤后的 todos</li><li>filter：过滤条件</li></ul></li><li><p>Action 应该有三种：</p><ul><li>ADD_TODO</li><li>TOGGLE_TODO</li><li>SET_VISIBILITY_FILTER</li></ul></li></ul><h4 id="3-2-2-编码实现"><a href="#3-2-2-编码实现" class="headerlink" title="3.2.2. 编码实现"></a>3.2.2. 编码实现</h4><h5 id="1-action-部分"><a href="#1-action-部分" class="headerlink" title="1. action 部分"></a>1. action 部分</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 暂且使用数字作为 id</span></span><br><span class="line"><span class="keyword">let</span> nextTodoId = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*-- action creators --*/</span></span><br><span class="line"><span class="keyword">const</span> addTodo = <span class="function">(<span class="params">text</span>) =&gt;</span> (</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">id</span>: nextTodoId++, text &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> toggleTodo = <span class="function">(<span class="params">id</span>) =&gt;</span> (</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, id &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> setVisibilityFilter = <span class="function">(<span class="params">filter</span>) =&gt;</span> (</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">'SET_VISIBILITY_FILTER'</span>, filter &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h5 id="2-reducer-部分"><a href="#2-reducer-部分" class="headerlink" title="2. reducer 部分"></a>2. reducer 部分</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认初始状态</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">filter</span>: <span class="string">'SHOW_ALL'</span>, <span class="attr">todos</span>: [] &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rootReducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">            <span class="comment">// 对象解构</span></span><br><span class="line">            <span class="keyword">const</span> &#123; id, text &#125; = action;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                todos: [</span><br><span class="line">                    ...state.todos,</span><br><span class="line">                    &#123; id, text, <span class="attr">completed</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">                ],</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                todos: state.todos.map(<span class="function"><span class="params">todo</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (todo.id !== action.id) <span class="keyword">return</span> todo;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> &#123;</span><br><span class="line">                        ...todo,</span><br><span class="line">                        completed: !todo.completed,</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;),</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                filter: action.filter,</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意!</p><ol><li>不要直接修改原有的 state，而是返回一个新的 state。可以使用 Object.assign() 新建一个新的 state。不能这样使用 Object.assign(state, { visibilityFilter: action.filter })，因为它会改变第一个参数的值。你必须把第一个参数设置为空对象。你也可以开启对 ES7 提案对象展开运算符的支持, 从而使用 { …state, …newState } 达到相同的目的。</li><li>在 default 的情况下返回旧的 state，用来兼容遇到未知的 action 这样的错误。</li></ol></blockquote><p><strong>拆分 reducer</strong><br>目前代码看着比较冗长，其实在逻辑上 todos 的处理和 filter 的处理应该分开，所以在 state 没有互相耦合时，可以将其拆分，从而让 reducer 精细地对于对应 state 的子树进行处理。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 处理单个 todo</span></span><br><span class="line"><span class="keyword">const</span> todoReducer = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                id: action.id,</span><br><span class="line">                text: action.text,</span><br><span class="line">                completed: <span class="literal">false</span>,</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">            <span class="keyword">if</span> (state.id !== action.id) <span class="keyword">return</span> state;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                completed: !state.completed,</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 todos</span></span><br><span class="line"><span class="keyword">const</span> todosReducer = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                ...state,</span><br><span class="line">                todoReducer(<span class="literal">undefined</span>, action),</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">            <span class="keyword">return</span> state.map(<span class="function"><span class="params">t</span> =&gt;</span> todoReducer(t, action));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 filter</span></span><br><span class="line"><span class="keyword">const</span> filterReducer = <span class="function">(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</span><br><span class="line">            <span class="keyword">return</span> action.filter;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="function">(<span class="params">state = initialState, action</span>) =&gt;</span> (&#123;</span><br><span class="line">    todos: todosReducer(state.todos, action),</span><br><span class="line">    filter: filterReducer(state.filter, action),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>注意观察最后的 rootReducer 函数，返回的是一个经过各种 reducer 处理过并合并后的新 state。</p><p>然鹅，注意这里 <code>todos: todos(state.todos, action),</code> 传入 state.todos，返回的一定也是 todos（因为都是 state 树上的节点）。</p><p>所以 redux 提供了很实用的 <code>combineReducers</code> api，用于简化 reducer 的合并。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</span><br><span class="line">    todos: todosReducer,</span><br><span class="line">    filter: filterReducer,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialState 可以作为第二个参数传入</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState);</span><br></pre></td></tr></table></figure><p>并且如果 reducer 与 state 节点同名的话（即 todosReducer -&gt; todos）还能通过 es6 的语法更进一步地简化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123; todos, filter &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialState 可以作为第二个参数传入</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState);</span><br></pre></td></tr></table></figure><p>随着应用的膨胀，我们还可以将拆分后的 reducer 放到不同的文件中, 以保持其独立性并用于专门处理不同的数据域。</p><h5 id="3-view-部分"><a href="#3-view-部分" class="headerlink" title="3. view 部分"></a>3. view 部分</h5><h6 id="1-只有根组件"><a href="#1-只有根组件" class="headerlink" title="1. 只有根组件"></a>1. 只有根组件</h6><p>首先只写一个根组件 <code>&lt;TodoApp /&gt;</code>，store 通过 props 传入 TodoApp，并在生命周期的 componentDidMount 和 componentWillUnmount 时分别订阅与取消订阅。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 订阅 store 的变化</span></span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.unsubscribe = store.subscribe(</span><br><span class="line">            <span class="keyword">this</span>.forceUpdate.bind(<span class="keyword">this</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消订阅</span></span><br><span class="line">    componentWillUnmount() &#123;</span><br><span class="line">        <span class="keyword">this</span>.unsubscribe();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染单个 todo</span></span><br><span class="line">    _renderTodo(todo) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;li</span><br><span class="line">                key=&#123;todo.id&#125;</span><br><span class="line">                onClick=&#123;() =&gt; store.dispatch(toggleTodo(todo.id))&#125;</span><br><span class="line">                style=&#123;&#123;</span><br><span class="line">                    textDecoration: todo.completed</span><br><span class="line">                        ? <span class="string">'line-through'</span></span><br><span class="line">                        : <span class="string">'none'</span>,</span><br><span class="line">                    cursor: todo.completed</span><br><span class="line">                        ? <span class="string">'default'</span></span><br><span class="line">                        : <span class="string">'pointer'</span>,</span><br><span class="line">                &#125;&#125;</span><br><span class="line">            &gt;</span><br><span class="line">                &#123;todo.text&#125;</span><br><span class="line">            &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 根据当前 filter 是否匹配，返回字符串或是 a 链接</span></span><br><span class="line"><span class="regexp">    _renderFilter(renderFilter, name) &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.props;</span></span><br><span class="line"><span class="regexp">        const &#123; filter &#125; = store.getState();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        if (renderFilter === filter) return name;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;a href='#' onClick=&#123;e =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                e.preventDefault();</span></span><br><span class="line"><span class="regexp">                store.dispatch(setVisibilityFilter(renderFilter))</span></span><br><span class="line"><span class="regexp">            &#125;&#125;&gt;</span></span><br><span class="line"><span class="regexp">                &#123;name&#125;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>a&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据当前 filter 过滤需要渲染的 todos</span></span><br><span class="line">    _getVisibleTodos(todos, filter) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (filter) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'SHOW_ALL'</span>:</span><br><span class="line">                <span class="keyword">return</span> todos;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'SHOW_COMPLETED'</span>:</span><br><span class="line">                <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> todo.completed);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> <span class="string">'SHOW_ACTIVE'</span>:</span><br><span class="line">                <span class="keyword">return</span> todos.filter(<span class="function"><span class="params">todo</span> =&gt;</span> !todo.completed);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> todos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> input;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &#123;<span class="comment">/* AddTodo */</span>&#125;</span><br><span class="line">                &lt;input type=<span class="string">"text"</span> ref=&#123;node =&gt; input = node&#125; /&gt;</span><br><span class="line">                &lt;button onClick=&#123;() =&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!input.value) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                    store.dispatch(addTodo(input.value));</span><br><span class="line">                    input.value = <span class="string">''</span>;</span><br><span class="line">                &#125;&#125;&gt;</span><br><span class="line">                    addTodo</span><br><span class="line">                &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                &#123;/</span>* TodoList *<span class="regexp">/&#125;</span></span><br><span class="line"><span class="regexp">                &lt;ul&gt;</span></span><br><span class="line"><span class="regexp">                    &#123;this._getVisibleTodos(todos, filter)</span></span><br><span class="line"><span class="regexp">                        .map(this._renderTodo.bind(this))</span></span><br><span class="line"><span class="regexp">                    &#125;</span></span><br><span class="line"><span class="regexp">                &lt;/u</span>l&gt;</span><br><span class="line"></span><br><span class="line">                &#123;<span class="comment">/* Footer */</span>&#125;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    Show:</span><br><span class="line">                    &#123;<span class="string">' '</span>&#125;</span><br><span class="line">                    &#123;<span class="keyword">this</span>._renderFilter(<span class="string">'SHOW_ALL'</span>, <span class="string">'all'</span>)&#125;</span><br><span class="line">                    &#123;<span class="string">', '</span>&#125;</span><br><span class="line">                    &#123;<span class="keyword">this</span>._renderFilter(<span class="string">'SHOW_COMPLETED'</span>, <span class="string">'completed'</span>)&#125;</span><br><span class="line">                    &#123;<span class="string">', '</span>&#125;</span><br><span class="line">                    &#123;<span class="keyword">this</span>._renderFilter(<span class="string">'SHOW_ACTIVE'</span>, <span class="string">'active'</span>)&#125;</span><br><span class="line">                &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>TodoApp 只有根组件</strong><br><iframe src="http://jsbin.com/bodise/edit?js,output" width="100%" height="800" frameborder="0" allowfullscreen></iframe></p><h6 id="2-组件拆分"><a href="#2-组件拆分" class="headerlink" title="2. 组件拆分"></a>2. 组件拆分</h6><p>将所有界面内容全写在 TodoApp 中实在是太臃肿了，接下来根据之前的分析结果将其分为以下子组件（全是展示组件）</p><ul><li>AddTodo</li><li>TodoList<ul><li>Todo</li></ul></li><li>Footer<ul><li>FilterLink</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AddTodo = <span class="function">(<span class="params">&#123; onAddClick &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> input;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;input type=<span class="string">"text"</span> ref=&#123;node =&gt; input = node&#125; /&gt;</span><br><span class="line">            &lt;button onClick=&#123;() =&gt; &#123;</span><br><span class="line">                onAddClick(input.value);</span><br><span class="line">                input.value = <span class="string">''</span>;</span><br><span class="line">            &#125;&#125;&gt;</span><br><span class="line">                addTodo</span><br><span class="line">            &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Todo = <span class="function">(<span class="params">&#123; text, onClick, completed &#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;li</span><br><span class="line">        onClick=&#123;onClick&#125;</span><br><span class="line">        style=&#123;&#123;</span><br><span class="line">            textDecoration: completed</span><br><span class="line">                ? <span class="string">'line-through'</span></span><br><span class="line">                : <span class="string">'none'</span>,</span><br><span class="line">            cursor: completed</span><br><span class="line">                ? <span class="string">'default'</span></span><br><span class="line">                : <span class="string">'pointer'</span>,</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">        &#123;text&#125;</span><br><span class="line">    &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const TodoList = (&#123; todos, onTodoClick &#125;) =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;ul&gt;</span></span><br><span class="line"><span class="regexp">        &#123;todos.map(todo =&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Todo</span></span><br><span class="line"><span class="regexp">                key=&#123;todo.id&#125;</span></span><br><span class="line"><span class="regexp">                &#123;...todo&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; onTodoClick(todo.id)&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const FilterLink = (&#123; filter, onClick, renderFilter, children &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    if (renderFilter === filter) return (&lt;span&gt;&#123;children&#125;&lt;/</span>span&gt;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;a href=<span class="string">'#'</span> onClick=&#123;e =&gt; &#123;</span><br><span class="line">            e.preventDefault();</span><br><span class="line">            onClick(renderFilter);</span><br><span class="line">        &#125;&#125;&gt;</span><br><span class="line">            &#123;children&#125;</span><br><span class="line">        &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Footer = (&#123; filter, onFilterClick &#125;) =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;p&gt;</span></span><br><span class="line"><span class="regexp">        Show:</span></span><br><span class="line"><span class="regexp">        &#123;' '&#125;</span></span><br><span class="line"><span class="regexp">        &lt;FilterLink</span></span><br><span class="line"><span class="regexp">            filter=&#123;filter&#125;</span></span><br><span class="line"><span class="regexp">            renderFilter="SHOW_ALL"</span></span><br><span class="line"><span class="regexp">            onClick=&#123;onFilterClick&#125;</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">            all</span></span><br><span class="line"><span class="regexp">        &lt;/</span>FilterLink&gt;</span><br><span class="line">        &#123;<span class="string">', '</span>&#125;</span><br><span class="line">        &lt;FilterLink</span><br><span class="line">            filter=&#123;filter&#125;</span><br><span class="line">            renderFilter=<span class="string">"SHOW_COMPLETED"</span></span><br><span class="line">            onClick=&#123;onFilterClick&#125;</span><br><span class="line">        &gt;</span><br><span class="line">            completed</span><br><span class="line">        &lt;<span class="regexp">/FilterLink&gt;</span></span><br><span class="line"><span class="regexp">        &#123;', '&#125;</span></span><br><span class="line"><span class="regexp">        &lt;FilterLink</span></span><br><span class="line"><span class="regexp">            filter=&#123;filter&#125;</span></span><br><span class="line"><span class="regexp">            renderFilter="SHOW_ACTIVE"</span></span><br><span class="line"><span class="regexp">            onClick=&#123;onFilterClick&#125;</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">            active</span></span><br><span class="line"><span class="regexp">        &lt;/</span>FilterLink&gt;</span><br><span class="line">    &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p>所以 TodoApp 精简后是这样~</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TodoApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">const</span> &#123; todos, filter &#125; = store.getState();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;AddTodo</span><br><span class="line">                    onAddClick=&#123;text =&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!text) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                        store.dispatch(addTodo(text));</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;TodoList</span><br><span class="line">                    todos=&#123;<span class="keyword">this</span>._getVisibleTodos(todos, filter)&#125;</span><br><span class="line">                    onTodoClick=&#123;id =&gt; store.dispatch(toggleTodo(id))&#125;</span><br><span class="line">                /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;Footer</span><br><span class="line">                    filter=&#123;filter&#125;</span><br><span class="line">                    onFilterClick=&#123;filter =&gt; &#123;</span><br><span class="line">                        store.dispatch(setVisibilityFilter(filter));</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">            &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><h6 id="3-增加容器组件"><a href="#3-增加容器组件" class="headerlink" title="3. 增加容器组件"></a>3. 增加容器组件</h6><p>现在我们仍然是以 TodoApp 作为容器组件，其中各个子组件都是展示组件。</p><p>但是这样做的话一旦子组件需要某个属性，就需要从根组件层层传递下来，比如 FilterLink 中的 filter 属性。</p><p>所以下面我们增加容器组件，让展示组件通过容器组件获得所需属性。</p><ul><li>AddTodo(container)</li><li>VisibleTodoList(container)<ul><li>TodoList<ul><li>Todo</li></ul></li></ul></li><li>Footer<ul><li>FilterLink(container)<ul><li>Link</li></ul></li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store.dispatch 又被放回来了，</span></span><br><span class="line"><span class="comment">// 因为暂时我们只在 AddTodo 组件中使用 addTodo 这个 action</span></span><br><span class="line"><span class="comment">// 以后增加了新的 form 之后可以考虑再将 store.dispatch 移出去</span></span><br><span class="line"><span class="keyword">const</span> AddTodo = <span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> input;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;input type=<span class="string">"text"</span> ref=&#123;node =&gt; input = node&#125; /&gt;</span><br><span class="line">            &lt;button onClick=&#123;() =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!input.value) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                store.dispatch(addTodo(input.value));</span><br><span class="line">                input.value = <span class="string">''</span>;</span><br><span class="line">            &#125;&#125;&gt;</span><br><span class="line">                addTodo</span><br><span class="line">            &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Todo = <span class="function">(<span class="params">&#123; text, onClick, completed &#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;li</span><br><span class="line">        onClick=&#123;onClick&#125;</span><br><span class="line">        style=&#123;&#123;</span><br><span class="line">            textDecoration: completed</span><br><span class="line">                ? <span class="string">'line-through'</span></span><br><span class="line">                : <span class="string">'none'</span>,</span><br><span class="line">            cursor: completed</span><br><span class="line">                ? <span class="string">'default'</span></span><br><span class="line">                : <span class="string">'pointer'</span>,</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">        &#123;text&#125;</span><br><span class="line">    &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const TodoList = (&#123; todos, onTodoClick &#125;) =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;ul&gt;</span></span><br><span class="line"><span class="regexp">        &#123;todos.map(todo =&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Todo</span></span><br><span class="line"><span class="regexp">                key=&#123;todo.id&#125;</span></span><br><span class="line"><span class="regexp">                &#123;...todo&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; onTodoClick(todo.id)&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">    &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 容器组件</span></span><br><span class="line"><span class="regexp">class VisibleTodoList extends Component &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 订阅 store 的变化</span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.props;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        this.unsubscribe = store.subscribe(</span></span><br><span class="line"><span class="regexp">            this.forceUpdate.bind(this)</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 取消订阅</span></span><br><span class="line"><span class="regexp">    componentWillUnmount() &#123;</span></span><br><span class="line"><span class="regexp">        this.unsubscribe();</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 根据当前 filter 过滤需要渲染的 todos</span></span><br><span class="line"><span class="regexp">    _getVisibleTodos(todos, filter) &#123;</span></span><br><span class="line"><span class="regexp">        switch (filter) &#123;</span></span><br><span class="line"><span class="regexp">            case 'SHOW_ALL':</span></span><br><span class="line"><span class="regexp">                return todos;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            case 'SHOW_COMPLETED':</span></span><br><span class="line"><span class="regexp">                return todos.filter(todo =&gt; todo.completed);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            case 'SHOW_ACTIVE':</span></span><br><span class="line"><span class="regexp">                return todos.filter(todo =&gt; !todo.completed);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            default:</span></span><br><span class="line"><span class="regexp">                return todos;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.props;</span></span><br><span class="line"><span class="regexp">        const &#123; todos, filter &#125; = store.getState();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;TodoList</span></span><br><span class="line"><span class="regexp">                todos=&#123;this._getVisibleTodos(todos, filter)&#125;</span></span><br><span class="line"><span class="regexp">                onTodoClick=&#123;id =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                    store.dispatch(toggleTodo(id))</span></span><br><span class="line"><span class="regexp">                &#125;&#125;</span></span><br><span class="line"><span class="regexp">            /</span>&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原本的 FilterLink 改成 Link，去掉 filter 和 renderFilter 属性，改为传入 active</span></span><br><span class="line"><span class="keyword">const</span> Link = <span class="function">(<span class="params">&#123; active, onClick, children &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (active) <span class="keyword">return</span> (&lt;span&gt;&#123;children&#125;&lt;/span&gt;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;a href=<span class="string">'#'</span> onClick=&#123;e =&gt; &#123;</span><br><span class="line">            e.preventDefault();</span><br><span class="line">            onClick();</span><br><span class="line">        &#125;&#125;&gt;</span><br><span class="line">            &#123;children&#125;</span><br><span class="line">        &lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 容器组件</span></span><br><span class="line"><span class="regexp">class FilterLink extends Component &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 订阅 store 的变化</span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.props;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        this.unsubscribe = store.subscribe(</span></span><br><span class="line"><span class="regexp">            this.forceUpdate.bind(this)</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 取消订阅</span></span><br><span class="line"><span class="regexp">    componentWillUnmount() &#123;</span></span><br><span class="line"><span class="regexp">        this.unsubscribe();</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store, renderFilter, children &#125; = this.props;</span></span><br><span class="line"><span class="regexp">        const &#123; filter &#125; = store.getState();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;Link</span></span><br><span class="line"><span class="regexp">                active=&#123;filter === renderFilter&#125;</span></span><br><span class="line"><span class="regexp">                onClick=&#123;() =&gt; store.dispatch(</span></span><br><span class="line"><span class="regexp">                    setVisibilityFilter(renderFilter)</span></span><br><span class="line"><span class="regexp">                )&#125;</span></span><br><span class="line"><span class="regexp">            &gt;</span></span><br><span class="line"><span class="regexp">                &#123;children&#125;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Link&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示组件</span></span><br><span class="line"><span class="keyword">const</span> Footer = <span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">        Show:</span><br><span class="line">        &#123;<span class="string">' '</span>&#125;</span><br><span class="line">        &lt;FilterLink</span><br><span class="line">            store=&#123;store&#125;</span><br><span class="line">            renderFilter=<span class="string">"SHOW_ALL"</span></span><br><span class="line">        &gt;</span><br><span class="line">            all</span><br><span class="line">        &lt;<span class="regexp">/FilterLink&gt;</span></span><br><span class="line"><span class="regexp">        &#123;', '&#125;</span></span><br><span class="line"><span class="regexp">        &lt;FilterLink</span></span><br><span class="line"><span class="regexp">            store=&#123;store&#125;</span></span><br><span class="line"><span class="regexp">            renderFilter="SHOW_COMPLETED"</span></span><br><span class="line"><span class="regexp">        &gt;</span></span><br><span class="line"><span class="regexp">            completed</span></span><br><span class="line"><span class="regexp">        &lt;/</span>FilterLink&gt;</span><br><span class="line">        &#123;<span class="string">', '</span>&#125;</span><br><span class="line">        &lt;FilterLink</span><br><span class="line">            store=&#123;store&#125;</span><br><span class="line">            renderFilter=<span class="string">"SHOW_ACTIVE"</span></span><br><span class="line">        &gt;</span><br><span class="line">            active</span><br><span class="line">        &lt;<span class="regexp">/FilterLink&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>p&gt;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在不使用全局变量 store 的情况下，</span></span><br><span class="line"><span class="comment">// 暂时只能通过 props 传递进来，</span></span><br><span class="line"><span class="comment">// Don't worry~很快就不会这么麻烦了~</span></span><br><span class="line"><span class="keyword">const</span> TodoApp = <span class="function">(<span class="params">&#123; store &#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;AddTodo store=&#123;store&#125; /&gt;</span><br><span class="line">        &lt;VisibleTodoList store=&#123;store&#125; /&gt;</span><br><span class="line">        &lt;Footer store=&#123;store&#125; /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure><p><strong>通过观察重构后的代码可以发现有三点麻烦的地方</strong></p><ol><li>根组件需要通过 props 将 store 传给各个子组件</li><li>容器组件都要定义 componentDidMount 进行订阅和 componentWillUnmount 取消订阅</li><li>应用其实并不需要渲染所有的 todos，所以内部很麻烦地定义了 <code>_getVisibleTodos</code> 函数</li></ol><h6 id="4-Provider"><a href="#4-Provider" class="headerlink" title="4. Provider"></a>4. Provider</h6><p>让我们先来解决第一个麻烦~，利用 React 提供的 <a href="http://facebook.github.io/react/docs/context.html" target="_blank" rel="noopener">context 特性</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过该方法向 children 的 context 注入 store</span></span><br><span class="line">    getChildContext() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.props.store &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.props.children;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须要声明传入 context 的 store 的类型</span></span><br><span class="line">Provider.childContextTypes = &#123;</span><br><span class="line">    store: React.PropTypes.object,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>自顶向下地看一下如何使用到 TodoApp 中</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 使用 Provider 包裹 TodoApp，并将 store 作为 props 传入</span></span><br><span class="line">ReactDOM.render(</span><br><span class="line">    &lt;Provider store=&#123;createStore(rootReducer, initialState)&#125;&gt;</span><br><span class="line">        &lt;TodoApp /&gt;</span><br><span class="line">    &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">    document.getElementById('container'),</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 2. 根组件 TodoApp: 和 store say goodbye~，</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 因为 TodoApp 并不是容器组件~</span></span><br><span class="line"><span class="regexp">const TodoApp = () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;AddTodo /</span>&gt;</span><br><span class="line">        &lt;VisibleTodoList /&gt;</span><br><span class="line">        &lt;Footer /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 3. AddTodo: 由于 props 固定作为第一个传入子组件的参数，</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 所以 &#123; store &#125; 要声明在第二位，然鹅需要声明 contextTypes...</span></span><br><span class="line"><span class="regexp">const AddTodo = (props, &#123; store &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 必须声明</span></span><br><span class="line"><span class="regexp">AddTodo.contextTypes = &#123;</span></span><br><span class="line"><span class="regexp">    store: React.PropTypes.object,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 4. VisibleTodoList: 从 props 改成从 context 中获取 store，</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 同样声明 contextTypes...</span></span><br><span class="line"><span class="regexp">class VisibleTodoList extends Component &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 订阅 store 的变化</span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.context; /</span><span class="regexp">/ props -&gt; context</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.context; /</span><span class="regexp">/ props -&gt; context</span></span><br><span class="line"><span class="regexp">        const &#123; todos, filter &#125; = store.getState();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 必须声明</span></span><br><span class="line"><span class="regexp">VisibleTodoList.contextTypes = &#123;</span></span><br><span class="line"><span class="regexp">    store: React.PropTypes.object,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ -- TodoList 和 Todo 不变 --</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 5. Footer：和 store say goodbye...</span></span><br><span class="line"><span class="regexp">const Footer = () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;p&gt;</span></span><br><span class="line"><span class="regexp">        Show:</span></span><br><span class="line"><span class="regexp">        &#123;' '&#125;</span></span><br><span class="line"><span class="regexp">        &lt;FilterLink renderFilter="SHOW_ALL"&gt;</span></span><br><span class="line"><span class="regexp">            all</span></span><br><span class="line"><span class="regexp">        &lt;/</span>FilterLink&gt;</span><br><span class="line">        &#123;<span class="string">', '</span>&#125;</span><br><span class="line">        &lt;FilterLink renderFilter=<span class="string">"SHOW_COMPLETED"</span>&gt;</span><br><span class="line">            completed</span><br><span class="line">        &lt;<span class="regexp">/FilterLink&gt;</span></span><br><span class="line"><span class="regexp">        &#123;', '&#125;</span></span><br><span class="line"><span class="regexp">        &lt;FilterLink renderFilter="SHOW_ACTIVE"&gt;</span></span><br><span class="line"><span class="regexp">            active</span></span><br><span class="line"><span class="regexp">        &lt;/</span>FilterLink&gt;</span><br><span class="line">    &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 6. FilterLink: 同 VisibleTodoList（props + contextTypes...）</span></span><br><span class="line"><span class="regexp">class FilterLink extends Component &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 订阅 store 的变化</span></span><br><span class="line"><span class="regexp">    componentDidMount() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.context; /</span><span class="regexp">/ props -&gt; context</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        const &#123; renderFilter, children &#125; = this.props;</span></span><br><span class="line"><span class="regexp">        const &#123; store &#125; = this.context; /</span><span class="regexp">/ props -&gt; context</span></span><br><span class="line"><span class="regexp">        const &#123; filter &#125; = store.getState();</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 必须声明</span></span><br><span class="line"><span class="regexp">FilterLink.contextTypes = &#123;</span></span><br><span class="line"><span class="regexp">    store: React.PropTypes.object,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ -- Link 不变 --</span></span><br></pre></td></tr></table></figure><p><strong>现在中间的非容器组件完全不用为了自己的孩子而费劲地传递 store={store}</strong><br>所以以上我们就实现了简化版的由 react-redux 提供的第一个组件 <code>&lt;Provider /&gt;</code>。</p><p>然鹅，有木有觉得老写 contextTypes 好烦啊，而且 context 特性并不稳定，所以 context 并不应该直接写在我们的应用代码里。</p><blockquote><p>计将安出？</p></blockquote><h6 id="5-connect"><a href="#5-connect" class="headerlink" title="5. connect"></a>5. connect</h6><ul><li>OOP思维：这还不简单？写个函数把容器组件传进去作为父类，然后返回写好了 componentDidMount，componentWillUnmount 和 contextTypes 的子类不就好啦~</li></ul><p>恭喜你~面向对象的思想学的很不错~</p><p>虽然 JavaScript 底层各种东西都是面向对象，然而在前端一旦与界面相关，照搬面向对象的方法实现起来会很麻烦…</p><ul><li>React 早期用户：这还不简单？写个 mixin 岂不美哉~~？</li></ul><p>作为 react 亲生的 mixin 确实在多组件间共享方法提供了一些便利，然而使用 mixin 的组件需要了解细节，从而避免状态污染，所以一旦 mixin 数量多了之后会越来越难维护。</p><blockquote><p>Unfortunately, we will not launch any mixin support for ES6 classes in React. That would defeat the purpose of only using idiomatic JavaScript concepts.</p></blockquote><p>所以官方也放弃了在 ES6 class 中对 mixin 的支持。</p><ul><li>函数式（FP）：高阶组件 High Order Component（下称 hoc）才是终极解决方案~~</li></ul><blockquote><p>hocFactory:: W: React.Component =&gt; E: React.Component</p></blockquote><p>如上所示 hoc 的构造函数接收一个 W（代表 WrappedComponent）返回一个 E（代表 Enhanced Component），而 E 就是这个高阶组件。</p><p>假设我们有一个旧组件 Comp，然鹅现在接收参数有些变动。</p><p>当然你可以复制粘贴再修改旧组件的代码…（大侠受窝一拜）</p><p>也可以这么写，返回一个新组件来包裹旧组件。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewComp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    mapProps(props) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="comment">/* new props */</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (&lt;Comp &#123;...this.mapProps(this.props)&#125; /&gt;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然鹅，如果有同样逻辑的更多的组件需要适配呢？？？总不能有几个抄几遍吧…</p><p><strong>所以骚年你听说过高阶组件么~？</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先返回一个函数，而那个函数再返回新组件</span></span><br><span class="line"><span class="keyword">const</span> mapProps = <span class="function"><span class="params">mapFn</span> =&gt;</span> Comp =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">        render() &#123;</span><br><span class="line">            <span class="keyword">return</span> (&lt;Comp &#123;...this.mapFn(this.props)&#125; /&gt;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const NewComp = mapProps(mapFn)(Comp); // 注意调用了两次</span><br></pre></td></tr></table></figure><p>可以看到借助高阶组件我们将 mapFn 和 Comp 解耦合，这样就算需要再嵌套多少修改逻辑都没问题<del>~天黑都不怕</del>~</p><p><strong>ok，扯了这么多的淡，终于要说到 connect 了</strong><br>是哒，你木有猜错，react-redux 提供的第二个也是最后一个 api —— connect 返回的就是一个高阶组件。</p><p>使用的时候只需要 <code>connect()(WrappedComponent)</code> 返回的 component 自动就完成了在 componentDidMount 中订阅 store，在 componentWillUnmount 中取消订阅和声明 contextTypes。</p><p><strong>这样就只剩下最后一个麻烦</strong></p><blockquote><p>3.应用其实并不需要渲染所有的 todos，所以内部很麻烦地定义了 <code>_getVisibleTodos</code> 函数</p></blockquote><p>其实 connect 函数的第一个参数叫做 mapStateToProps，作用就是将 store 中的数据提前处理或过滤后作为 props 传入内部组件，以便内部组件高效地直接调用。这样最后一个麻烦也解决了~</p><p><strong>然鹅，我们问自己这样就够了么？并没有…</strong></p><p>还有最后一个细节，以 FilterLink 为例。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterLink</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; store, renderFilter, children &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="keyword">const</span> &#123; filter &#125; = store.getState();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;Link</span><br><span class="line">                active=&#123;filter === renderFilter&#125;</span><br><span class="line">                onClick=&#123;() =&gt; store.dispatch(</span><br><span class="line">                    setVisibilityFilter(renderFilter)</span><br><span class="line">                )&#125;</span><br><span class="line">            &gt;</span><br><span class="line">                &#123;children&#125;</span><br><span class="line">            &lt;<span class="regexp">/Link&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>除了从 store 中获取数据（filter），我们还从中获取了 dispatch，以便触发 action。如果将回调函数 onClick 的内容也加到 props 中，那么借助 connect 整个 FilterLink 的逻辑岂不是都被我们抽象完了？</p><p>是哒，connect 的第二个参数叫做 mapDispatchToProps，作用就是将各个调用到 dispatch 的地方都抽象成函数加到 props 中的传给内部组件。这样最后一个麻烦终于真的被解决了~</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mapStateToLinkProps = <span class="function">(<span class="params">state, ownProps</span>) =&gt;</span> (&#123;</span><br><span class="line">    <span class="comment">// ownProps 是原组件的 props，</span></span><br><span class="line">    <span class="comment">// 这里为了和高阶组件的 props 区分</span></span><br><span class="line">    active: ownProps.renderFilter === state.filter,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mapDispatchToLinkProps = <span class="function">(<span class="params">dispatch, ownProps</span>) =&gt;</span> (&#123;</span><br><span class="line">    onClick() &#123;</span><br><span class="line">        dispatch(</span><br><span class="line">            setVisibilityFilter(ownProps.renderFilter)</span><br><span class="line">        );</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意原 FilterLink 整个都被我们删了</span></span><br><span class="line"><span class="keyword">const</span> FilterLink = connect(</span><br><span class="line">    mapStateToLinkProps,</span><br><span class="line">    mapDispatchToLinkProps</span><br><span class="line">)(Link);</span><br></pre></td></tr></table></figure><p><strong>TodoApp 使用 react-redux</strong><br><iframe src="http://jsbin.com/fumihi/edit?js,output" width="100%" height="800" frameborder="0" allowfullscreen></iframe></p><h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>本文从 Redux 的理论基础和源码出发，介绍了 Redux 的各项基础 api。</p><p>接着一步一步地介绍如何与 React 进行结合，从过程中的各个痛点引出 react-redux 的作用和原理。</p><p>然鹅，还有好多的坑没填，比如：大型项目的文件结构、前端路由（react-router）、中间件（middlewares）、网络请求等各类异步操作、服务器端同构直出…</p><p>以上 to be continued…</p><blockquote><p>本文地址： <a href="https://buptsteve.github.io/blog/2016/10/25/007.redux-basis/" target="_blank" rel="external">https://buptsteve.github.io/blog/2016/10/25/007.redux-basis/</a></p><footer><cite><a href="https://buptsteve.github.io/blog">@BuptStEve's Blog</a></cite></footer></blockquote></div><nav class="post-nav"><div class="waves-block waves-effect prev fl"><a href="/blog/2017/01/02/008.advanced-redux/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">「8」Redux 进阶 - react 全家桶学习笔记（二）</h4></a></div><div class="waves-block waves-effect next fr"><a href="/blog/2016/03/23/006.js-function-chapter7/" id="post-next" class="post-nav-link"><div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">「6」JavaScript 函数表达式学习笔记</h4></a></div></nav></div></div></article></div></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><script src="/blog/js/wave.min.js"></script><script src="/blog/js/main.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><script type="text/template" id="search-tpl"><li class="item">
        <a href="/{path}" class="waves-block waves-effect">
            <div class="title ellipsis" title="{title}">{title}</div>
            
            <div class="flex-row flex-middle">
                <div class="tags ellipsis">
                    {tags}
                </div>

                <time class="flex-col time">{date}</time>
            </div>
        </a>
    </li></script><script src="/blog/js/search.js"></script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-85691829-1","auto"),ga("send","pageview")</script></body></html>